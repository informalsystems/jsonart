{
  "description": "Specification for transforming an Apalache counterexample into a Tendermint test",
  "prerequisites": "add the directory with 'tendermint-rs/mbt-utils/mbt-tendermint-produce' to your $PATH",
  "input": [
    {
      "name": "now",
      "kind": "COMMAND",
      "source": "date --utc --iso-8601=seconds"
    },
    {
      "name": "fixed_now",
      "kind": "INLINE",
      "source": "2020-06-27T19:40:55.882270778Z"
    },
    {
      "name": "ce",
      "kind": "FILE",
      "source": "tests/support/counterexample.json"
    },
    {
      "name": "last_state",
      "kind": "INLINE",
      "source": "$ce.declarations[-2]"
    },
    {
      "name": "blockchain",
      "kind": "INLINE",
      "source": "$last_state..[?(@.left == 'blockchain')].right.tuple | unwrap"
    },
    {
      "name": "first_block",
      "kind": "INLINE",
      "source": "$blockchain[0]"
    },
    {
      "name": "VS",
      "kind": "INLINE",
      "source": "$..[?(@.left.str == 'VS')].right..str"
    },
    {
      "name": "NextVS",
      "kind": "INLINE",
      "source": "$..[?(@.left.str == 'NextVS')].right..str"
    },

    {
      "name": "height",
      "kind": "INLINE",
      "source": "$..[?(@.left.str == 'height')].right | unwrap"
    },
    {
      "name": "block_to_header",
      "kind": "INLINE",
      "source": {
        "validators": "$ | VS | map(id_to_validator)",
        "next_validators": "$ | NextVS | map(id_to_validator)",
        "height": "$ | height",
        "time": "$fixed_now"
      }
    },
    {
      "name": "block_to_commit",
      "kind": "INLINE",
      "source": {
        "header": "$ | block_to_header"
      }
    },
    {
      "name": "id_to_validator",
      "kind": "INLINE",
      "source": {
        "id": "$"
      }
    },
    {
      "name": "mbt_produce_validator",
      "kind": "COMMAND",
      "source": "mbt-tendermint-produce --read-stdin validator --voting-power 50 --proposer-priority -100"
    },
    {
      "name": "mbt_produce_header",
      "kind": "COMMAND",
      "source": "mbt-tendermint-produce --read-stdin header"
    },
    {
      "name": "mbt_produce_commit",
      "kind": "COMMAND",
      "source": "mbt-tendermint-produce --read-stdin commit"
    },
    {
      "name": "block_to_signed_header",
      "kind": "INLINE",
      "source": {
        "header": "$ | block_to_header | mbt_produce_header",
        "commit": "$ | block_to_commit | mbt_produce_commit"
      }
    },
    {
      "name": "ids_to_validator_set",
      "kind": "INLINE",
      "source": {
        "validators": "$ | map(mbt_produce_validator)",
        "proposer": "$[0] | unwrap | mbt_produce_validator"
      }
    },
    {
      "name": "block_to_light_block",
      "kind": "INLINE",
      "source": {
        "signed_header": "$ | block_to_signed_header",
        "validator_set": "$ | VS | ids_to_validator_set",
        "next_validator_set": "$ | NextVS | ids_to_validator_set"
      }
    }
  ],
  "output": {
    "description": "auto-generated from Apalache counterexample",
    "initial": {
      "signed_header": "$first_block | block_to_signed_header",
      "next_validator_set": "$first_block | NextVS | ids_to_validator_set",
      "trusting_period": "10800000000000",
      "now": "$fixed_now"
    },
    "input": "$blockchain[1:] | map(block_to_light_block)",
    "expected_output": "$last_state..[?(@.left == 'outEvent')].right.record[?(@.left.str == 'verdict')].right | unwrap"
  }
}